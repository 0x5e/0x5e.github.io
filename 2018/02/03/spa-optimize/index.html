<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> SPA性能优化实践 · 0x5e的博客</title><meta name="description" content="SPA性能优化实践 - 0x5e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.0x5e.cn/atom.xml" title="0x5e的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/imgs/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/0x5e" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINK</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">SPA性能优化实践</h1><div class="post-info">Feb 3, 2018</div><div class="post-content"><h1 id="代码体积优化"><a href="#代码体积优化" class="headerlink" title="代码体积优化"></a>代码体积优化</h1><h2 id="代码分割（Code-Splitting）"><a href="#代码分割（Code-Splitting）" class="headerlink" title="代码分割（Code Splitting）"></a>代码分割（Code Splitting）</h2><p>代码分割可以拆分业务模块和三方模块，在版本迭代时降低三方模块的更新频率，还可以实现资源文件按需加载，加快应用首屏加载速度。</p>
<h3 id="业务代码拆分"><a href="#业务代码拆分" class="headerlink" title="业务代码拆分"></a>业务代码拆分</h3><p>在开发以及版本迭代的过程中，三方模块很少有变化，可以拆分出来，通过浏览器缓存，加快新版应用的载入速度。</p>
<a id="more"></a>
<p>1.在<code>webpack.config.js</code>定义多个entry入口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// entry: './index.js',</span></span><br><span class="line">    entry: &#123;</span><br><span class="line">        main: <span class="string">'./index.js'</span>,</span><br><span class="line">        vendor: [</span><br><span class="line">            <span class="string">'react'</span>,</span><br><span class="line">            <span class="string">'react-router'</span>,</span><br><span class="line">            <span class="string">'moment'</span>,</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>vendor可以手动指定，也可以把<code>package.json</code>里的<code>dependencies</code>全部加入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vendor: [</span><br><span class="line">    ...Object.keys(path.resolve(<span class="string">'./package.json'</span>).dependencies),</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>设置完以后，打包出来的<code>main.js</code>包含业务+公共代码，<code>vendor.js</code>包含公共代码。</p>
<p>2.使用<code>CommonsChunkPlugin</code>插件，指定vendor为公共模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    plugins: &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">            names: [<span class="string">'vendor'</span>, <span class="string">'manifest'</span>],</span><br><span class="line">        &#125;),</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>manifest是webpack的运行时模块，会随业务代码而改变，需要与公共模块分离。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.6 KB (-150.45 KB)  build/static/js/main.6b091018.js</span><br><span class="line">145.54 KB              build/static/js/vendor.5e7317a1.js</span><br><span class="line">35.39 KB               build/static/css/main.6123c843.css</span><br><span class="line">835 B                  build/static/js/manifest.24abdf54.js</span><br></pre></td></tr></table></figure>
<p>可以看到main文件拆分后，减少了将近一半的体积。<code>vendor.[hash].js</code>被浏览器缓存，因为更变不频繁，这部分代码很大概率不需要重复下载了。</p>
<h3 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h3><p>当SPA应用包含了多个页面的时候，首屏页面代码是必须被加载的，而其他页面并不一定会去访问，因此这部分代码并不是必须的，可以按需加载。</p>
<p>webpack提供了<code>import()</code>方法在运行时动态加载ES Module，返回一个Promise对象。</p>
<p>配合react-router可以做如下改动：</p>
<p>改动前：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter <span class="keyword">as</span> Router, Router, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Task <span class="keyword">from</span> <span class="string">'./task'</span>;</span><br><span class="line"><span class="keyword">import</span> Mall <span class="keyword">from</span> <span class="string">'./mall'</span>;</span><br><span class="line"><span class="keyword">import</span> My <span class="keyword">from</span> <span class="string">'./my'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; (</span><br><span class="line">  &lt;Router&gt;</span><br><span class="line">    &lt;Switch&gt;</span><br><span class="line">      &lt;Route exact path=<span class="string">'/task'</span> component=&#123;Task&#125; /&gt;</span><br><span class="line">      &lt;Route exact path=<span class="string">'/mall'</span> component=&#123;Mall&#125; /&gt;</span><br><span class="line">      &lt;Route exact path=<span class="string">'/my'</span> component=&#123;My&#125; /&gt;</span><br><span class="line">      &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line">    &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Router&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>改动后：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter <span class="keyword">as</span> Router, Route, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asyncComponent = <span class="function">(<span class="params">importComponent</span>) =&gt;</span> (</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AsyncComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    state = &#123;</span><br><span class="line">      component: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">default</span>: component &#125; = <span class="keyword">await</span> importComponent();</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; component &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">const</span> C = <span class="keyword">this</span>.state.component</span><br><span class="line">      <span class="keyword">return</span> C</span><br><span class="line">        ? &lt;C &#123;...this.props&#125; /&gt;</span><br><span class="line">        : null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">export default () =&gt; (</span><br><span class="line">  &lt;Router&gt;</span><br><span class="line">    &lt;Switch&gt;</span><br><span class="line">      &lt;Route exact path='/task' component=&#123;asyncComponent(() =&gt; import(/* webpackChunkName: 'task' */ './task'))&#125; /&gt;</span><br><span class="line">      &lt;Route exact path='/mall' component=&#123;asyncComponent(() =&gt; import(/* webpackChunkName: 'mall' */ './mall'))&#125; /&gt;</span><br><span class="line">      &lt;Route exact path='/my' component=&#123;asyncComponent(() =&gt; import(/* webpackChunkName: 'my' */ './my'))&#125; /&gt;</span><br><span class="line">      &#123;/* ... */&#125;</span><br><span class="line">    &lt;/Switch&gt;</span><br><span class="line">  &lt;/Router&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>将每个页面从<code>import Page from &#39;./path/to/page&#39;</code>的同步加载改为<code>() =&gt; import(&#39;./path/to/page)</code>异步加载，加载完毕后再渲染到页面上。</p>
<p>webpack会对这种加载方式进行优化，每个页面的代码打包成单独的文件，在需要时按需加载。文件名称通过<code>import()</code>参数中写注释指定。例如<code>/* webpackChunkName: &#39;xxx&#39; */</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">144.68 KB (-873 B)    build/static/js/vendor.dd6678e3.js</span><br><span class="line">48.2 KB               build/static/js/task.4ef57338.chunk.js</span><br><span class="line">44.74 KB              build/static/js/mall.3f31508b.chunk.js</span><br><span class="line">40.02 KB              build/static/js/my.16e54bab.chunk.js</span><br><span class="line">13.73 KB (-21.67 KB)  build/static/css/main.c8a90ac2.css</span><br><span class="line">9.05 KB (-163.55 KB)  build/static/js/main.b7f8610d.js</span><br><span class="line">1.19 KB (+383 B)      build/static/js/manifest.7d1798c7.js</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>main.js从170k变成了9k，访问<code>/my</code>页面时所需的代码文件体积从170k变成了9k+40k，减少了约70%的体积。</p>
<h1 id="资源文件优化"><a href="#资源文件优化" class="headerlink" title="资源文件优化"></a>资源文件优化</h1><p>图片：</p>
<ul>
<li>图标用css、svg、iconfont代替</li>
<li>渐进式图片加载</li>
<li>访问oss的图片资源带上参数（比如运营同学上传了几十张超清大图。。。）</li>
<li>图片懒加载</li>
</ul>
<h1 id="服务端优化"><a href="#服务端优化" class="headerlink" title="服务端优化"></a>服务端优化</h1><ul>
<li>启用gzip压缩（很简单，效果也很明显）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">##</span><br><span class="line"># Gzip Settings</span><br><span class="line">##</span><br><span class="line">gzip on;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_min_length 10k;</span><br><span class="line">gzip_proxied expired no-cache no-store private auth;</span><br><span class="line">gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br></pre></td></tr></table></figure>
<ul>
<li>http2多路复用</li>
<li>开启HSTS</li>
<li>服务端渲染</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://blog.csdn.net/forAlienZHOU/article/details/73437057" target="_blank" rel="noopener">react-router 4 代码拆分</a><br><a href="https://zhuanlan.zhihu.com/p/26228500" target="_blank" rel="noopener">基于webpack Code Splitting实现react组件的按需加载</a><br><a href="https://github.com/mrdulin/blog/issues/43" target="_blank" rel="noopener">使用import()配合webpack动态导入模块时，如何指定chunk name</a><br><a href="https://segmentfault.com/a/1190000007141049" target="_blank" rel="noopener">react-router 按需加载</a><br><a href="https://segmentfault.com/a/1190000011128817" target="_blank" rel="noopener">webpack v3 结合 react-router v4 做 dynamic import — 按需加载（懒加载）</a><br><a href="https://medium.com/front-end-hacking/lazy-loading-with-react-and-webpack-2-8e9e586cf442" target="_blank" rel="noopener">Lazy Loading with React and Webpack 2</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/10/14/patch-npm-package/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = '0x5e';
var disqus_identifier = '2018/02/03/spa-optimize/';
var disqus_title = 'SPA性能优化实践';
var disqus_url = 'https://blog.0x5e.cn/2018/02/03/spa-optimize/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//0x5e.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2019 <a href="https://blog.0x5e.cn">0x5e</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-102733496-1",'auto');ga('send','pageview');</script></body></html>