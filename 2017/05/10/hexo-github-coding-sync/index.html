<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Hexo同时部署到Github和Coding并分流 · 0x5e的博客</title><meta name="description" content="Hexo同时部署到Github和Coding并分流 - 0x5e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.0x5e.cn/atom.xml" title="0x5e的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/imgs/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/0x5e" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINK</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Hexo同时部署到Github和Coding并分流</h1><div class="post-info">May 10, 2017</div><div class="post-content"><p>最近比较闲，可以整理一下博客。。</p>
<p>做分流是因为，平时还是Github用的多，不想把博客的项目单独存放在Coding上，但是呢又想让国内访问快一点（是不是很矫情）</p>
<p>本文主要内容有：</p>
<ul>
<li>travis自动部署<ul>
<li>生成ssh key</li>
<li>设置deploy key</li>
</ul>
</li>
<li>绑定自定义域名</li>
<li>域名海内外分流</li>
</ul>
<a id="more"></a>
<h2 id="用户-Pages-amp-项目-Pages"><a href="#用户-Pages-amp-项目-Pages" class="headerlink" title="用户 Pages &amp; 项目 Pages"></a>用户 Pages &amp; 项目 Pages</h2><p>每个用户只能创建一个用户Pages，每个项目只能创建一个项目Pages。<br>用户Pages只能从<code>master</code>分支部署，这个坑了我好久，没看仔细。。</p>
<p><a href>https://coding.net/help/doc/pages/index.html#pages–pages</a></p>
<table>
<thead>
<tr>
<th style="text-align:left">Pages类型</th>
<th style="text-align:left">Pages默认URL</th>
<th style="text-align:left">允许的部署来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Github 用户 Pages</td>
<td style="text-align:left"><code>{user_name}.github.io</code></td>
<td style="text-align:left"><code>master</code> 分支</td>
</tr>
<tr>
<td style="text-align:left">Github 项目 Pages</td>
<td style="text-align:left"><code>{user_name}.github.io/{project_name}</code></td>
<td style="text-align:left"><code>master</code>分支、<code>gh-pages</code>分支、或<code>master</code>分支中的<code>/docs</code>目录</td>
</tr>
<tr>
<td style="text-align:left">Coding 用户 Pages</td>
<td style="text-align:left"><code>{user_name}.coding.me</code></td>
<td style="text-align:left"><code>master</code> 分支</td>
</tr>
<tr>
<td style="text-align:left">Coding 项目 Pages</td>
<td style="text-align:left"><code>{user_name}.coding.me/{project_name}</code></td>
<td style="text-align:left"><code>master</code>分支、<code>coding-pages</code>分支、或<code>master</code>分支中的<code>/docs</code>目录</td>
</tr>
</tbody>
</table>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>因为上面的原因，我把博客源文件存放在<code>0x5e.github.io</code>的<code>blog</code>分支，编译的网页文件提交到<code>0x5e.github.io</code>和<code>0x5e.coding.me</code>的<code>master</code>分支。（建仓库就不说了）</p>
<h3 id="本地部署"><a href="#本地部署" class="headerlink" title="本地部署"></a>本地部署</h3><p>安装插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add hexo-deployer-git</span><br></pre></td></tr></table></figure>
<p>在<code>_config.yml</code>文件添加配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment"># Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:0x5e/0x5e.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@git.coding.net:0x5e/0x5e.coding.me.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>新建一篇文章，然后执行<code>hexo deploy</code>，完成。</p>
<h3 id="Travis自动部署"><a href="#Travis自动部署" class="headerlink" title="Travis自动部署"></a>Travis自动部署</h3><h4 id="创建ssh-key"><a href="#创建ssh-key" class="headerlink" title="创建ssh key"></a>创建ssh key</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;Travis CI&quot;</span><br></pre></td></tr></table></figure>
<h4 id="设置为项目deploy-key"><a href="#设置为项目deploy-key" class="headerlink" title="设置为项目deploy key"></a>设置为项目deploy key</h4><p>把刚才创建的ssh公钥加入项目中，注意：需要开启写入权限</p>
<p>Github: <code>Settings</code> =&gt; <code>Deploy keys</code> =&gt; <code>Add deploy key</code><br>Coding: <code>设置</code> =&gt; <code>部署公钥</code> =&gt; <code>新建部署公钥</code></p>
<h4 id="加密ssh私钥"><a href="#加密ssh私钥" class="headerlink" title="加密ssh私钥"></a>加密ssh私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Install travis</span><br><span class="line">sudo gem install -n -n /usr/local/bin travis</span><br><span class="line"></span><br><span class="line"># Login</span><br><span class="line">travis login --auto</span><br><span class="line"></span><br><span class="line"># Encrypt</span><br><span class="line">travis enctypt-file /path/to/id_rsa --add</span><br></pre></td></tr></table></figure>
<p>把生成的<code>id_rsa.enc</code>保存到<code>.travis/id_rsa.enc</code>，待会用到</p>
<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>修改<code>.travis.yml</code>配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"7"</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  yarn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  directories:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">node_modules</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_44ad502b10c9_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_44ad502b10c9_iv</span> <span class="bullet">-in</span> <span class="string">.travis/id_rsa.enc</span> <span class="bullet">-out</span> <span class="string">~/.ssh/id_rsa</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">eval</span> <span class="string">$(ssh-agent)</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ssh-add</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">cp</span> <span class="string">.travis/ssh_config</span> <span class="string">~/.ssh/config</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">'0x5e'</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">'0x5e@sina.cn'</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">global</span> <span class="string">add</span> <span class="string">hexo-cli</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">deploy</span>  <span class="comment"># hexo clean &amp;&amp; hexo g -d</span></span><br><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">  ssh_known_hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">github.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git.coding.net</span></span><br></pre></td></tr></table></figure>
<p><code>encrypted_xxx_key</code>，<code>encrypted_xxx_iv</code>改为对应的值，还有name &amp; email。</p>
<p><code>ssh_known_hosts</code>也需要添加，不然第一次链接ssh的时候会提示输入<code>yes/no</code>，导致无法自动构建而失败。</p>
<h2 id="绑定自定义域名"><a href="#绑定自定义域名" class="headerlink" title="绑定自定义域名"></a>绑定自定义域名</h2><p>Github: 新增一条<code>CNAME</code>记录到<code>{user_name}.github.io</code>。<br>Coding: 新增一条<code>CNAME</code>记录到<code>pages.coding.me</code>，然后在项目设置里添加自定义域名。</p>
<h3 id="海内外分流"><a href="#海内外分流" class="headerlink" title="海内外分流"></a>海内外分流</h3><p>其实就是添加两条相同的主机记录，分别到Github和Coding，只是解析线路一条设置为海外，一条设置为国内（默认），如图：</p>
<p><img src="dns-resolve.png" alt></p>
<p>就这样。。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://munen.cc/tech/coding-pages.html" target="_blank" rel="noopener">在 GITHUB 和 CODING 上同步托管 HEXO 博客</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/11/being-a-salty-fish/" class="prev">PREV</a><a href="/2017/03/29/ptp-ip-note/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = '0x5e';
var disqus_identifier = '2017/05/10/hexo-github-coding-sync/';
var disqus_title = 'Hexo同时部署到Github和Coding并分流';
var disqus_url = 'https://blog.0x5e.cn/2017/05/10/hexo-github-coding-sync/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//0x5e.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2019 <a href="https://blog.0x5e.cn">0x5e</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-102733496-1",'auto');ga('send','pageview');</script></body></html>