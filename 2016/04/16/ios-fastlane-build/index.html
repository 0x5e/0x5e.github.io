<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS使用Fastlane多渠道自动化打包 · 0x5e的博客</title><meta name="description" content="iOS使用Fastlane多渠道自动化打包 - 0x5e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.0x5e.cn/atom.xml" title="0x5e的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/imgs/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/0x5e" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINK</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS使用Fastlane多渠道自动化打包</h1><div class="post-info">Apr 16, 2016</div><div class="post-content"><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>由于需求的变化，公司打算将同一份App提供给不同的厂商，名称、图标、配色等由厂商自定义，内部称作公版App，随着客户越来越多，手工修改肯定是不满足要求的，必须得自动化。</p>
<p>之前一直在用python打企业包上传至蒲公英，xcodebuild用着还是有点复杂的。。后来发现了fastlane，好东西呀，还有好多功能有待尝试😊</p>
<a id="more"></a>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>先整理了一下需要自定义的部分，打算整理成一份配置文件，在打包之前自动替换各种资源文件和参数，然后自动打包，再上传到蒲公英：</p>
<ul>
<li>应用名称（多语言）</li>
<li>版本号</li>
<li>Bundle Id</li>
<li>URL Scheme</li>
<li>FAQ、隐私政策的地址</li>
<li>Copyright文案</li>
<li>配色方案（UED提供，导航栏、列表、提示、按钮等各种颜色、背景色）</li>
<li>平台AppKey、SceretKey</li>
<li>友盟AppKey</li>
<li>登录方式（手机、邮箱）、是否要支持第三方登录</li>
<li>第三方登录的各种Key</li>
<li>应用图标</li>
<li>启动图</li>
<li>其它图标</li>
</ul>
<p>参数与Android保持统一，方便以后服务端集成两方的自动打包脚本。</p>
<p>因为支持多语言，应用名称保存在<code>./项目名/*.lproj/InfoPlist.strings</code>中，<code>CFBundleDisplayName=xxx</code>, 可以直接新建文本来替换。</p>
<p>版本号、BundleId、URL Scheme等参数可用<code>/usr/libexec/PlistBuddy</code>进行替换。</p>
<p>配色方案我整理在一个plist文件里，也一样替换。</p>
<p>应用图标可以用python的PIL库切成各种尺寸的图直接替换，启动图由于比例有好多种，暂时先让客户提供了。</p>
<p>剩下所有参数以宏定义的方式整理在了一个头文件中，替换之☺️</p>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>图片资源、配置参数替换之前用python已经写好了。fastlane主要用来打包签名上传，采用配置文件的形式显得清晰一些，可以稍微少写几行代码。</p>
<p>读取配置文件，转成字典：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">	print(<span class="string">'usage: python package_ios.py [配置文件目录]'</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">config_dir = sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./%s/config.json'</span> % config_dir) <span class="keyword">as</span> data_file:</span><br><span class="line">	<span class="comment">#过滤注释。。。。</span></span><br><span class="line">	data = data_file.read()</span><br><span class="line">	array = data.split(<span class="string">'\n'</span>)</span><br><span class="line">	data = <span class="string">''</span></span><br><span class="line">	<span class="keyword">for</span> a <span class="keyword">in</span> array:</span><br><span class="line">		data += a.split(<span class="string">'\t//'</span>)[<span class="number">0</span>] + <span class="string">'\n'</span></span><br><span class="line">	config = json.loads(data)</span><br></pre></td></tr></table></figure>
<p>替换应用名称：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f = codecs.open(<span class="string">'./TuyaSmart/zh-Hans.lproj/InfoPlist.strings'</span>,<span class="string">'w+b'</span>,<span class="string">'UTF-8'</span>)</span><br><span class="line">f.write(<span class="string">'CFBundleDisplayName="%s";'</span> % config[<span class="string">'app_name_cn'</span>])</span><br><span class="line">f.close()</span><br><span class="line">//...</span><br></pre></td></tr></table></figure>
<p>替换配色方案：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace_color</span><span class="params">(config)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> (key, value) <span class="keyword">in</span> config[<span class="string">'colors'</span>].items():</span><br><span class="line">		os.system(<span class="string">'/usr/libexec/PlistBuddy -c "set %s %s" ./TuyaSmart/customColor.plist'</span> % (key, value))</span><br></pre></td></tr></table></figure>
<p>生成各个尺寸应用图标、替换启动图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace_icon</span><span class="params">(config_dir)</span>:</span></span><br><span class="line">	icon_path = <span class="string">'./%s/res/Icon.png'</span> % config_dir</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(icon_path):</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">	img_orig = Image.open(icon_path).convert(<span class="string">'RGBA'</span>)</span><br><span class="line">	</span><br><span class="line">	dic = &#123;</span><br><span class="line">		<span class="string">'Icon-29@2x.png'</span>: (<span class="number">58</span>, <span class="number">58</span>),</span><br><span class="line">		<span class="string">'Icon-29@3x.png'</span>: (<span class="number">87</span>, <span class="number">87</span>),</span><br><span class="line">		<span class="string">'Icon-40@2x.png'</span>: (<span class="number">80</span>, <span class="number">80</span>),</span><br><span class="line">		<span class="string">'Icon-40@3x.png'</span>: (<span class="number">120</span>, <span class="number">120</span>),</span><br><span class="line">		<span class="string">'Icon-60@2x.png'</span>: (<span class="number">120</span>, <span class="number">120</span>),</span><br><span class="line">		<span class="string">'Icon-60@3x.png'</span>: (<span class="number">180</span>, <span class="number">180</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (name, size) <span class="keyword">in</span> dic.items():</span><br><span class="line">		img = img_orig.resize(size, Image.ANTIALIAS)</span><br><span class="line">		img.save(<span class="string">'./TuyaSmart/Images.xcassets/AppIcon.appiconset/%s'</span> % name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	img_path = <span class="string">'./TuyaSmart/Images.xcassets/AppIcon.appiconset/Icon-60@2x.png'</span></span><br><span class="line">	<span class="keyword">if</span> os.path.isfile(img_path):</span><br><span class="line">		shutil.copy(img_path, <span class="string">'./TuyaSmart/业务/Base/Resource/'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace_launch_img</span><span class="params">(config_dir)</span>:</span></span><br><span class="line">	arr = [</span><br><span class="line">		<span class="string">'01-login-preview-4.png'</span>,</span><br><span class="line">		<span class="string">'01-login-preview-5s.png'</span>,</span><br><span class="line">		<span class="string">'01-login-preview-6.png'</span>,</span><br><span class="line">		<span class="string">'01-login-preview-6plus.png'</span>,</span><br><span class="line">	]</span><br><span class="line">	<span class="keyword">for</span> name <span class="keyword">in</span> arr:</span><br><span class="line">		img_path = <span class="string">'./%s/res/%s'</span> % (config_dir, name)</span><br><span class="line">		<span class="keyword">if</span> os.path.isfile(img_path):</span><br><span class="line">			shutil.copy(img_path, <span class="string">'./TuyaSmart/Images.xcassets/LaunchImage.launchimage/'</span>)</span><br></pre></td></tr></table></figure>
<p>调用fastlane打包：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.system(<span class="string">'fastlane Enterprise bundleId:%s'</span> % config[<span class="string">'packageName'</span>])</span><br></pre></td></tr></table></figure>
<h3 id="Fastfile配置"><a href="#Fastfile配置" class="headerlink" title="Fastfile配置"></a>Fastfile配置</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">ENTERPRISE_IDENTIFIER = <span class="string">'com.xxx.xxx.Hoc'</span></span><br><span class="line">ENTERPRISE_CODESIGNING_IDENTITY = <span class="string">'iPhone Distribution: xxxx'</span></span><br><span class="line"></span><br><span class="line">PLIST_FILE_PATH = <span class="string">'xxx/Info.plist'</span></span><br><span class="line"></span><br><span class="line">uKey = <span class="string">'xxxx'</span></span><br><span class="line">_api_key = <span class="string">'xxxx'</span></span><br><span class="line"></span><br><span class="line">before_all <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."</span></span><br><span class="line">  cocoapods</span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">desc <span class="string">"使用方法 `fastlane Enterprise bundleId:&lt;Bundle Id&gt;`"</span></span><br><span class="line">lane <span class="symbol">:Enterprise</span> <span class="keyword">do</span> <span class="params">|options|</span></span><br><span class="line"></span><br><span class="line">  time = Time.new</span><br><span class="line">  date = <span class="string">"<span class="subst">#&#123;time.year&#125;</span>.<span class="subst">#&#123;time.month&#125;</span>.<span class="subst">#&#123;time.day&#125;</span>"</span></span><br><span class="line">  badge(<span class="symbol">shield:</span> <span class="string">"build-<span class="subst">#&#123;date&#125;</span>-blue"</span>)</span><br><span class="line"></span><br><span class="line">  bundleId = options[<span class="symbol">:bundleId</span>]</span><br><span class="line">  <span class="comment"># version = get_info_plist_value(path: PLIST_FILE_PATH, key: "CFBundleShortVersionString")</span></span><br><span class="line">  gym(</span><br><span class="line">    <span class="symbol">scheme:</span> <span class="string">"TuyaSmartPublic"</span>,</span><br><span class="line">    <span class="symbol">clean:</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="symbol">silent:</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="symbol">archive_path:</span> <span class="string">"./Build/<span class="subst">#&#123;bundleId&#125;</span>/"</span>,</span><br><span class="line">    <span class="symbol">output_directory:</span> <span class="string">"./Build/<span class="subst">#&#123;bundleId&#125;</span>/"</span>,</span><br><span class="line">    <span class="symbol">output_name:</span> <span class="string">"<span class="subst">#&#123;bundleId&#125;</span>-<span class="subst">#&#123;date&#125;</span>.ipa"</span>,</span><br><span class="line">    <span class="symbol">export_method:</span> <span class="string">"enterprise"</span>,</span><br><span class="line">    <span class="symbol">configuration:</span> <span class="string">"Release"</span>,</span><br><span class="line">    <span class="symbol">xcargs:</span> <span class="string">"PRODUCT_BUNDLE_IDENTIFIER=\"<span class="subst">#&#123;ENTERPRISE_IDENTIFIER&#125;</span>\""</span>,</span><br><span class="line">    <span class="symbol">codesigning_identity:</span> <span class="string">"<span class="subst">#&#123;ENTERPRISE_CODESIGNING_IDENTITY&#125;</span>"</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  sh <span class="string">"echo '上传至蒲公英...' curl -F 'file=@../Build/<span class="subst">#&#123;bundleId&#125;</span>/<span class="subst">#&#123;bundleId&#125;</span>-<span class="subst">#&#123;date&#125;</span>.ipa' -F 'uKey=<span class="subst">#&#123;uKey&#125;</span>' -F '_api_key=<span class="subst">#&#123;_api_key&#125;</span>' -F 'updateDescription=<span class="subst">#&#123;bundleId&#125;</span>' http://www.pgyer.com/apiv1/app/upload"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You can define as many lanes as you want</span></span><br><span class="line"></span><br><span class="line">after_all <span class="keyword">do</span> <span class="params">|lane|</span></span><br><span class="line">  <span class="comment"># This block is called, only if the executed lane was successful</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># slack(</span></span><br><span class="line">  <span class="comment">#   message: "Successfully deployed new App Update."</span></span><br><span class="line">  <span class="comment"># )</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">error <span class="keyword">do</span> <span class="params">|lane, exception|</span></span><br><span class="line">  <span class="comment"># slack(</span></span><br><span class="line">  <span class="comment">#   message: exception.message,</span></span><br><span class="line">  <span class="comment">#   success: false</span></span><br><span class="line">  <span class="comment"># )</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>用<code>badge</code>可以给企业包的应用图标加标签，方便区分，很实用</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ul>
<li>“鼓励一下我们”的功能，需要跳转至App Store对应的地址<code>https://itunes.apple.com/app/id%@</code>，需要客户创建应用后从苹果后台获取App Id，很麻烦。后来找到一个接口可以根据Bundle Id查询App Id <code>https://itunes.apple.com/lookup?bundleId=%@</code>，解决了这个问题。</li>
<li>蒲公英文件的分块上传，当时对python和分块上传都不熟悉，找了好多代码，后来蒲公英开发文档里建议用curl分块上传。。</li>
<li>Bundle Id需要去苹果后台手动创建，目前打的都是企业包，给客户演示用的，如果公用一个Bundle Id，上传至蒲公英、fir.im都会被归到同一个地址去，没法做区分。这个暂时没时间解了，等服务端同学做出后台来吧😊</li>
</ul>
<h2 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h2><ul>
<li>codesigning、provisioning做成可配置（参照APICloud）</li>
<li>用jenkins持续集成</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.devlizy.com/ios-da-bao-quan-cheng-pei-zhi/" target="_blank" rel="noopener">iOS 持续集成之 fastlane + jenkins (持续更新)</a></p>
<p><a href="http://everettjf.github.io/2015/09/08/ios-ci-with-fastlane" target="_blank" rel="noopener">使用fastlane实现iOS持续集成</a></p>
<p><a href="http://ios.jobbole.com/82532/" target="_blank" rel="noopener">如何在运行时改变App的图标</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/04/30/xingbei-crack/" class="prev">PREV</a><a href="/2016/02/21/iphone-brick-again/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = '0x5e';
var disqus_identifier = '2016/04/16/ios-fastlane-build/';
var disqus_title = 'iOS使用Fastlane多渠道自动化打包';
var disqus_url = 'https://blog.0x5e.cn/2016/04/16/ios-fastlane-build/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//0x5e.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2019 <a href="https://blog.0x5e.cn">0x5e</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-102733496-1",'auto');ga('send','pageview');</script></body></html>